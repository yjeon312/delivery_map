<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ì¹´ì¹´ì˜¤ ì§€ë„ ê²½ìœ ì§€ ìµœì í™” ê²½ë¡œ</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; }
        #map { width: 100%; height: 500px; border-radius: 10px; border: 1px solid #ccc; }
        .input-group { margin-bottom: 5px; }
        .input-panel { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        input { padding: 8px; width: 280px; margin-bottom: 5px; }
        button { padding: 8px 12px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        .btn-add { background: #e9ecef; }
        .btn-search { background: #fee500; width: 100%; margin-top: 10px; font-size: 16px; }
        #result { margin-top: 15px; padding: 10px; border-left: 5px solid #fee500; background: #fffdf0; display: none; }
    </style>
</head>
<body>

    <div class="input-panel">
        <div class="input-group">
            <strong>ì¶œë°œ:</strong> <input type="text" id="startAddr" value="ì„œìš¸ì—­">
        </div>
        <div id="waypoint-container">
            <div class="input-group">
                <strong>ê²½ìœ :</strong> <input type="text" class="waypoint-addr" placeholder="ê²½ìœ ì§€ ì£¼ì†Œ ì…ë ¥">
            </div>
        </div>
        <button class="btn-add" onclick="addWaypointField()">+ ê²½ìœ ì§€ ì¶”ê°€</button>
        <div class="input-group" style="margin-top:10px;">
            <strong>ë„ì°©:</strong> <input type="text" id="endAddr" value="ë¶€ì‚°ì—­">
        </div>
        <button class="btn-search" onclick="getOptimizedRoute()">ìµœì  ê²½ë¡œ íƒìƒ‰ (ìˆœì„œ ìµœì í™”)</button>
    </div>

    <div id="result"></div>
    <div id="map"></div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=cc6395efcb6491cc27cc6346dc2f5283&libraries=services"></script>

    <script>
        const mapContainer = document.getElementById('map');
        const mapOption = { center: new kakao.maps.LatLng(37.5668, 126.9786), level: 3 };
        const map = new kakao.maps.Map(mapContainer, mapOption);
        const geocoder = new kakao.maps.services.Geocoder();
        let polyline = null;
        let markers = [];

        // ê²½ìœ ì§€ ì…ë ¥ í•„ë“œ ì¶”ê°€ í•¨ìˆ˜
        function addWaypointField() {
            const container = document.getElementById('waypoint-container');
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `<strong>ê²½ìœ :</strong> <input type="text" class="waypoint-addr" placeholder="ê²½ìœ ì§€ ì£¼ì†Œ ì…ë ¥">`;
            container.appendChild(div);
        }

        async function getOptimizedRoute() {
            const restApiKey = '53a905aaf52c117f0fca4725228fa007';
            const startAddr = document.getElementById('startAddr').value;
            const endAddr = document.getElementById('endAddr').value;
            const wpElements = document.getElementsByClassName('waypoint-addr');

            try {
                // 1. ì£¼ì†Œë¥¼ ì¢Œí‘œë¡œ ë³€í™˜
                const origin = await addressSearch(startAddr);
                const destination = await addressSearch(endAddr);
                
                let waypoints = [];
                for (let el of wpElements) {
                    if (el.value.trim() !== "") {
                        const coords = await addressSearch(el.value);
                        waypoints.push({ name: el.value, x: coords.lng, y: coords.lat });
                    }
                }

                // 2. ì¹´ì¹´ì˜¤ ëª¨ë¹Œë¦¬í‹° REST API í˜¸ì¶œ (ë‹¤ì¤‘ ê²½ìœ ì§€ ìµœì í™”)
                // waypoints êµ¬ì¡°: "x,y|x,y" í˜•íƒœ
                const wpQuery = waypoints.map(w => `${w.x},${w.y}`).join('|');
                
                // REST API URL êµ¬ì„± (ìµœì í™” ì˜µì…˜ í¬í•¨)
                let url = `https://apis-navi.kakaomobility.com/v1/directions?origin=${origin.lng},${origin.lat}&destination=${destination.lng},${destination.lat}&priority=RECOMMEND&waypoint_priority=OPTIMIZE`;
                if(wpQuery) url += `&waypoints=${wpQuery}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `KakaoAK ${restApiKey}` }
                });

                const data = await response.json();

                if (data.routes && data.routes[0]) {
                    const route = data.routes[0];
                    displayResult(route);
                    drawRouteOnMap(route);
                } else {
                    alert("ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

            } catch (err) {
                console.error(err);
                alert("íƒìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì£¼ì†Œê°€ ì •í™•í•œì§€ í™•ì¸í•˜ì„¸ìš”.");
            }
        }

        function addressSearch(address) {
            return new Promise((resolve, reject) => {
                geocoder.addressSearch(address, (result, status) => {
                    if (status === kakao.maps.services.Status.OK) {
                        resolve({ lat: result[0].y, lng: result[0].x });
                    } else reject("Address not found");
                });
            });
        }

        function displayResult(route) {
            const resDiv = document.getElementById('result');
            const dist = (route.summary.distance / 1000).toFixed(2);
            const time = Math.floor(route.summary.duration / 60);
            
            resDiv.style.display = 'block';
            resDiv.innerHTML = `
                <strong>ğŸš— ìµœì í™” ê²°ê³¼</strong><br>
                - ì´ ê±°ë¦¬: ${dist} km<br>
                - ì˜ˆìƒ ì†Œìš” ì‹œê°„: ì•½ ${time}ë¶„<br>
                <small>* ê²½ìœ ì§€ ë°©ë¬¸ ìˆœì„œê°€ ìµœë‹¨ ì‹œê°„/ê±°ë¦¬ ê¸°ì¤€ìœ¼ë¡œ ìë™ ì¬ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.</small>
            `;
        }

        function drawRouteOnMap(route) {
            // ì´ˆê¸°í™”
            if (polyline) polyline.setMap(null);
            markers.forEach(m => m.setMap(null));
            markers = [];

            const linePath = [];
            const bounds = new kakao.maps.LatLngBounds();

            // ì„¹ì…˜ë³„(êµ¬ê°„ë³„) ê²½ë¡œ ì¢Œí‘œ ì¶”ì¶œ
            route.sections.forEach(section => {
                section.roads.forEach(road => {
                    road.vertexes.forEach((v, i) => {
                        if (i % 2 === 0) {
                            const point = new kakao.maps.LatLng(road.vertexes[i+1], road.vertexes[i]);
                            linePath.push(point);
                            bounds.extend(point);
                        }
                    });
                });
            });

            // ê²½ë¡œ ê·¸ë¦¬ê¸°
            polyline = new kakao.maps.Polyline({
                path: linePath,
                strokeWeight: 5,
                strokeColor: '#FF33E9',
                strokeOpacity: 0.8
            });
            polyline.setMap(map);

            // ì¶œë°œ/ë„ì°© ë§ˆì»¤
            const startNode = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(route.summary.origin.y, route.summary.origin.x),
                map: map
            });
            markers.push(startNode);

            const endNode = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(route.summary.destination.y, route.summary.destination.x),
                map: map
            });
            markers.push(endNode);

            map.setBounds(bounds);
        }
    </script>
</body>
</html>